---
title: "Assignment 1: Oakland's TOD"
author: "Alex Nelms"
date: "9/8/2021"
output: github_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tigris_class = "sf")
```

```{r setup_package, warning = FALSE, message = FALSE}
library(tidyverse)
library(tidycensus)
library(sf)
library(tmap) # mapping, install if you don't have it
set.seed(717)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    
    
    plot.background = element_blank(),
    
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    
    strip.text.x = element_text(size = 14)
  )
}

```

# Bay Area Rapid Transit (BART) in the East Bay

### A Transit Oriented Development Study

------------------------------------------------------------------------

## 1. Data Wrangling

### 1.A Transit Routes & Stops

Transit Routes & Stops are for the Bay Area Regional Transit, the San Francisco Bay Area's hybrid subway-commuter rail.
The data was sourced from the regional [Metropolitan Transportation Commission](https://opendata.mtc.ca.gov/ "MTC Open Data Portal"), who collected the data from the varying transit agencies.
The files themselves were pulled from the open data site's API queries.

```{r 1A_transit_import}

if (exists("BART_stops")==FALSE){
  BART_stops =
    st_read("https://services3.arcgis.com/i2dkYWmb4wHvYPda/arcgis/rest/services/transitstops_existing_planned_2021/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=2227&f=geojson") %>%
    filter(agency_id == "BA", route_s_nm!="Blue-Sun") %>%
    mutate(
      route_s_nm = ifelse(
        route_s_nm=="Blue-Wkd/Sat", "Blue", 
        route_s_nm)
    )
  CA_crs = st_crs(BART_stops)
  cat(CA_crs$input, ', EPSG:', CA_crs$epsg)
  
  BART_routes = 
    st_read("https://services3.arcgis.com/i2dkYWmb4wHvYPda/arcgis/rest/services/transitroutes_01_2020/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=2227&f=geojson") %>%
    filter(agency_id == "BA", route_s_nm!="Blue-Sun") %>%
    mutate(
      route_s_nm = ifelse(
        route_s_nm=="Blue-Wkd/Sat", "Blue", 
        route_s_nm)
    ) %>%
    st_transform(., CA_crs)
}
```

```{r 1A_transit_prep}


```

### 1.B Census 2000

Census

```{r 1C_Tract2000}

# VIew variables
View(load_variables(2000, "sf1", cache = TRUE))

v00 = c("P001001",   # total pop
         "P053001",   # median household income
         "P033001",   # aggregate time to work
         "P033011",   # aggregate time to work over 60 mins
         "P037001",   # total over 25yr
         "P037016",   # Male total w/ Masters
         "P037017",   # Male total w/ Prof
         "P037018",   # Male total w/ Doct
         "P037033",   # Female total w/ Masters
         "P037034",   # Female total w/ Prof
         "P037035",   # Female total w/ Doct
         
        )

v19 = c(
  "B01003_001",  # total pop
  "B19013_001",  # median household income
  "B08135_001",  # aggregate time to work
  "B08135_010",  # aggregate time to work over 60 mins
  "B15003_001",  # total over 25yr
  "B15003_023",  # total w/ Masters
  "B15003_024",  # total w/ Prof
  "B15003_025",  # total w/ Doct
         )

  col_nm = c("total_pop",  
             "med_HH_income",
             "agg_time_commute",
             "agg_time_commute60")


# get census 2000
tracts00 = 
  get_decennial(
    geography = "tract", 
    variables = tracts00_var, 
    year=2000, state='CA', county='Alameda',
    geometry=T) %>% 
  st_transform(CA_crs)

# rename cols
## names(df1) = with(dict,newName[match(names(df1),oldName)])

total_pop.2016 = B01001_001E,
          total_HU.2016 = B25002_001E,
          total_vacant.2016 = B25002_003E,
          med_HH_Income.2016 = B19013_001E,
          total_White.2016 = B02001_002E,
          total_GradDeg.2016 = B06009_006E) %>%

```

### 1.C ACS 2019

Census

```{r 1C_Tract2019}

tracts19_var = c(
  "B25026_001E",                                         "B02001_002E",                                         "B15001_050E",                                         "B15001_009E",                                         "B19013_001E",                                         "B25058_001E",                                         "B06012_002E"                                          )

tracts19 <-  
  get_acs(
    geography = "tract", 
    variables = tracts19_var, 
    year=2019, state='CA', county='Alameda',
    geometry=T) %>% 
  st_transform(CA_crs)


```

### 1.D Crime Data

Crime

```{r 1D_Crime}

api_key = "ZfuhpSK1tX9XxWicYM7ew1lHSPYCF9mI2MnKZdBd"



```

------------------------------------------------------------------------

## 2 Four Time & Space Maps

***Comparing TOD & non-TOD Tracts between 2000 & 2019***

Median Rent, [Second], [Third], [Fourth]

### 2.A Median Rent Map

```{r 2A_variable1}

```

### 2.B Second Variable Map

```{r 2B_variable2}

```

### 2.C Second Variable Map

```{r 2C_variable3}

```

### 2.D Fourth Variable Map

```{r 2D_variable4}

```

------------------------------------------------------------------------

## 3 Bar Plot

*One grouped bar plot making these same comparisons*

```{r 3_barplot}

```

------------------------------------------------------------------------

## 4 Table

*One table making these same comparisons*

```{r 4_table}

```

------------------------------------------------------------------------

## 5 Graduated Symbol Maps

*Two Graduated Symbol Maps within 0.5 miles transit stations*

### 5.B Map of Population within ½ Mile of BART Stations

```{r 5A_pop}

```

### 5.B Map of Rent within ½ Mile of BART Stations

```{r 5B_rent}

```

------------------------------------------------------------------------

## 6 Geom Line Plots

***Rent & Crime compared to the Distance to BART stations***

```{r 6_geom_line}

```

------------------------------------------------------------------------

## 7 Policy Brief

------------------------------------------------------------------------

## Load data from {tidycensus}

```{r acs_vars, cache = TRUE, message = FALSE, warning = FALSE, results=FALSE}
acs_vars <- c(
    "B01001_001",    # ACS total Pop stimat
    "B15003_001",
    "B25002_001",     # stimat of total housing units
    "B25002_003",     # Numbr of vacant housing units
    "B19013_001",    # Mdian HH Incom ($)
    "B02001_002",  # Popl dscribing thmslvs as "whit alon"
    "B07010_001",     # stimat!!Total Individuals
    "B07010_002",  # stimat!!Total:!!No incom
    "B07010_011", # stimat!!Total:!!With incom:!!$75,000 or mor
    "B07010_023",   # stimat!!Total:!!Movd within sam county:
    "B07010_034",  # stimat!!Total:!!Movd from diffrnt county:
    "B07010_045",   # stimat!!Total:!!Movd from diffrnt country:
    "B07010_012",  # Estimate!!Total:!!Same house 1 year ago:
    "B15003_023",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_024",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_025"  #Estimate!!Total:!!Disc jockeys, except radio

              ) 

myTracts <- c(
    "42101007400", 
    "42101007300", 
    "42101008000", 
    "42101007800", 
    "42101007700",
    "42101008000",
    "42101007900",
    "42101008802", # just west of UPENN
    #"42101036900", # UPENN, hospitals, woodlands
    #"42101008801", # UPENN
    "42101008702",
    "42101008701",
    "42101008601"
              )


acsTractsPHL.2019.sf <- get_acs(geography = "tract",
                             year = 2019,
                             variables = acs_vars,
                             geometry = TRUE,
                             state  = "PA",
                             county = "Philadelphia",
                             output = "wide") %>%
  dplyr::select (GEOID, NAME, all_of(paste0(acs_vars,"E"))) %>%
  rename (
      total_pop.2019 = B01001_001E,    # ACS total Pop estimate
      total_25yrpop.2019 = B15003_001E,
      total_HU.2019 = B25002_001E,     # Estimate of total housing units
      total_vacant.2019 = B25002_003E,     # Number of vacant housing units
      med_HH_income.2019 = B19013_001E,    # Median HH Income ($)
      total_white.2019 = B02001_002E,  # People describing themselves as "white alone"
      total_indi.2019 = B07010_001E,     # Estimate!!Total Individuals
      total_no_income.2019 = B07010_002E,  # Estimate!!Total:!!No income
      total_income_75k.2019 = B07010_011E, # Estimate!!Total:!!With income:!!$75,000 or more
      total_moved_incnty.2019 = B07010_023E,   # Estimate!!Total:!!Moved within same county:
      total_moved_outcnty.2019 = B07010_034E,  # Estimate!!Total:!!Moved from different county:
      total_moved_outusa.2019 = B07010_045E,   # Estimate!!Total:!!Moved from different country:
      total_same_house_1yr.2019 = B07010_012E,  # Estimate!!Total:!!Same house 1 year ago:
      total_masters.2019 = B15003_023E
  ) %>%
  mutate(
    Neighborhood = ifelse(GEOID %in% myTracts,
                               "CLARK PARK",
                               "REST OF PHILADELPHIA"),
    moved_1yr_PCT.2019 = (1 - total_same_house_1yr.2019 / total_indi.2019 )*100,
    masters_PCT.2019 = ((total_masters.2019 + B15003_024E+ B15003_025E) / total_25yrpop.2019 )*100
    )
```

## Transform to WGS84 with {sf}

```{r}
acsTractsPHL.2019.sf <- acsTractsPHL.2019.sf %>% 
  st_transform(crs = "EPSG:4326")
```

## Plot with {ggplot2}

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}
max_pct = max(acsTractsPHL.2019.sf$moved_1yr_PCT.2019[is.finite(acsTractsPHL.2019.sf$moved_1yr_PCT.2019)])

ggplot()+
  # POLYGON color 
  geom_sf(data = acsTractsPHL.2019.sf, 
          aes(fill = moved_1yr_PCT.2019),
          color = "transparent")+
  # blank on top
  geom_sf(data = acsTractsPHL.2019.sf %>%
            filter(Neighborhood == "CLARK PARK") %>%
            st_union(),
            color = "black",
            size=1, #linetype="longdash",
            fill = "transparent"
          ) + 
  scale_fill_gradient2(
      low="green4", mid="white", high="red4", midpoint=20,
      breaks = c(0,20,40,60), labels = c("0%","20%","40%","60%"),
      name="% of New Residents")+
  guides(fill = guide_colourbar(barheight = 10))+
  labs(
    title = "Percentage of individuals who have moved in the last year",
    subtitle = "Focus on the Clark Park neighborhood") +
  theme(plot.title = element_text(hjust = 0.5), axis.title.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        panel.background = element_rect(fill='gray'))
```

\# )

\#brewer.pal(3, name="Dark2")

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}

library(RColorBrewer)


ggplot()+
  #POLYGON
  geom_sf(data = acsTractsPHL.2019.sf,
          fill = "white",
          color = "grey75"
          )+
  # POINT
  geom_sf(data = acsTractsPHL.2019.sf  %>%
          st_centroid(),                # to centroid
          shape = 21, color='grey10',
          aes(
            size = masters_PCT.2019,    # set point size by column value
            fill = masters_PCT.2019     # set point fill ('color') by column value
          )) +
  # Scale for the Point Size
  scale_size_continuous(
          range = c(0,6),             # range of point sizes
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          labels = c("0 to 19 %", "20 to 39 %", "40 to 59%", "60+ %"), 
                                        # legend labels
          name="% of People over 25yrs with a \nMaster's, Doctoral, or Professional Degree"
          )+
  scale_fill_stepsn(                    # binned scale of point fill
          colors = RColorBrewer::brewer.pal( # pulling ColorBrewer list of colors
                      4,                # amount of bins
                      name="BuPu"       # ColorBrewer palette
                      ),
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          guide = FALSE                 # remove legend (so we can have one combo)
          )+
    labs(
          title = "Percentage of Adults who earned \n a Master's Degree or Higher",
          ) +
    theme(
          axis.title=element_blank(), 
          axis.text=element_blank(), axis.ticks=element_blank(), # remove ticks
          panel.background = element_rect(fill='gray')
          )+
    guides(
          size = guide_legend(
              override.aes = list(fill = brewer.pal(4, name="BuPu"))
          ))                            # add the ColorBrewer list to the legend
```
