---
title: "Assignment 1: Oakland's TOD"
author: "Alex Nelms"
date: "9/8/2021"
output: github_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tigris_class = "sf")
```

```{r setup_package, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(patchwork)
library(scales)
library(kableExtra)

library(tidycensus)
library(sf)
library(sp)
library(tmap)
library(ggrepel)
library(tigris)




mile = 5280
sqmile = 27878400

set.seed(717)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    
    
    plot.background = element_blank(),
    
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    
    strip.text.x = element_text(size = 14)
  )
}

key_file = "C:/Users/nelms/OneDrive/Code/census_api_key.txt"
census_key = readChar(key_file, file.info(key_file)$size)
census_api_key(census_key, overwrite = TRUE)
```

# Bay Area Rapid Transit (BART) in the East Bay

### A Transit Oriented Development Study

------------------------------------------------------------------------

## 1. Data Wrangling

### 1.A.1 Transit Routes & Stops

Transit Routes & Stops are for the Bay Area Regional Transit, the San Francisco Bay Area's hybrid subway-commuter rail.
Looking at this transportation system allows us to focus on both urban cetners and their immediate suburbs.
The data was sourced from the regional [Metropolitan Transportation Commission](https://opendata.mtc.ca.gov/ "MTC Open Data Portal").

```{r 1A1_transit_import, include=FALSE}

#stop_path = "https://services3.arcgis.com/i2dkYWmb4wHvYPda/arcgis/rest/services/transitstops_existing_planned_2021/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=2227&f=geojson"
stop_path = 'C:/Users/nelms/OneDrive/Penn/MUSA-508/Files/SF-Bay_Transit-Stops-Major_2021.geojson'

#route_path = "https://services3.arcgis.com/i2dkYWmb4wHvYPda/arcgis/rest/services/transitroutes_01_2020/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=2227&f=geojson"
route_path = 'C:/Users/nelms/OneDrive/Penn/MUSA-508/Files/BART_routes.geojson'

BART.stops =
  # from the MTC API, who sourced it from BART
  st_read(stop_path) %>%
  # only look at BART & weekday routes
  filter(agency_id == "BA", route_s_nm!="Blue-Sun", route_s_nm!='Beige') %>%
  mutate(
    route_s_nm = ifelse(
      route_s_nm=="Blue-Wkd/Sat", "Blue", 
      route_s_nm)
  ) %>%
  st_transform(., 2227)

# Projection is (NAD83) California State Plan, Zone 2 (in FEET)
# EPSG:2226
CA_crs = st_crs(BART.stops)
#cat(CA_crs$input, ', EPSG:', CA_crs$epsg)

BART.routes = 
  st_read(route_path) %>%
  filter(agency_id == "BA", route_s_nm!="Blue-Sun") %>%
  mutate(
    route_s_nm = ifelse(
      route_s_nm=="Blue-Wkd/Sat", "Blue", 
      route_s_nm)
  ) %>%
  st_transform(., CA_crs)
```

### 1.A.2 Prepare Transit & East Bay City Boundary Data

Narrowing down Census Tracts & Transit stations to the urban area of the Eastern San Francisco Bay Area *"East Bay"*: Oakland, Berkeley, and the immediate suburban cities of Alameda, Albany, Emeryville, and Albany.\*

```{r 1A2_transit_prep, include = FALSE}

# PULL CITY BOUNDARIES FROM REGIONAL MTC OPEN DATA
#city_path = 'https://services3.arcgis.com/i2dkYWmb4wHvYPda/arcgis/rest/services/region_jurisdiction_clp/FeatureServer/0/query?where=1%3D1&outFields=jurname,fipco&outSR=2227&f=geojson'
city_path = 'C:/Users/nelms/OneDrive/Penn/MUSA-508/Files/EastBay_cities.geojson'
EB.cities = st_read(city_path) 

#EB.all    = st_read(city_path) %>% st_union(.) %>% st_transform(., CA_crs)

# NARROW AREAS TO MAJOR & MINOR CITIES
major_EB = c('Berkeley', 'Oakland')
minor_EB = c('Alameda', 'Albany', 'Emeryville', 'Piedmont')
is_EB = c(minor_EB, major_EB)
EB.cities = EB.cities[match(is_EB, EB.cities$jurname), ] %>%
  select( -fipco) %>%
  rename(
    city = jurname
  ) %>%
  st_transform(., CA_crs)
EB.cities$size = 'minor'
EB.cities[EB.cities$city %in% major_EB, 'size'] = 'major'

# NARROW STOPS TO .5 MILE OUTSIDE THESE CITIES
BART.stops =
  BART.stops %>%
  # .5 mile buffer + 1 foot
  st_filter(., st_buffer(st_union(EB.cities), dist=5280*.5+1)) %>%
  group_by(stop_nm,stop_id) %>%
  st_drop_geometry(.) %>%
  summarise(
    route_count = n_distinct(route_s_nm), # get routes used
    routes      = list(unique(route_s_nm))
  ) %>%
  merge(., BART.stops[,'stop_id'], by='stop_id') %>%
  distinct() %>% # remove duplicates
  st_as_sf()

# NARROW STOPS TO THESE CITIES 
BART.routes = st_intersection(BART.routes, st_buffer(st_union(EB.cities),5280*.5))

# CREATE CITY LABELS
EB.labels = 
  EB.cities %>%
  st_centroid(EB.cities) %>%
  rename(
    label = city
  ) %>%
  mutate(
       lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
       lat = map_dbl(geometry, ~st_centroid(.x)[[2]])
     )

```

### 1.A.3 1/2 Mile Buffers of BART Stops

```{r 1A3_Buffers, echo=FALSE}

buffer_distance = .5

min_point_distances = function(
  input.geoms,
  input.ids,
  compare.geoms,
  compare.ids
){
  # GET DISTANCES OF TRANSIT STOPS AND THE FOCUS AREA BOUNDARY
  distances_matrix = 
    outer(input.geoms,
          compare.geoms,
          FUN=Vectorize(st_distance, USE.NAMES = FALSE))
  
  # CREATE MATRIX COLUMN & ROW NAMES
  rownames(distances_matrix) = input.ids
  colnames(distances_matrix) = compare.ids
  
  get_col = function(rowname, find_num){
    return(colnames(distances_matrix)[distances_matrix[rowname, ] == find_num])
  }
  get_col = Vectorize(get_col)
  distances_df =
    apply(distances_matrix, 1, min) %>% as.data.frame() %>%
    rename('distance'=1) %>%
    rownames_to_column('ID') %>%
    mutate(closest=get_col(ID, distance))
  
  return(distances_df)
}

EB.coords = EB.cities %>% 
    st_convex_hull() %>% 
    st_cast(., "MULTIPOINT") %>%
    st_union() %>%
    st_cast(., "POINT")

BARTstop_EBboundary_distances = min_point_distances(
  input.geoms = EB.coords,
  input.ids   = seq(from=1,to=length(EB.coords)),
  compare.geoms = BART.stops$geometry,
  compare.ids = BART.stops$stop_id
)
  
# GET LARGEST CLOSEST DISTANCE (MILES) BETWEEN STOPS AND BOUNDARY
max_min_BART_EB_dist = 
  max(BARTstop_EBboundary_distances$distance)/mile

# MINIMUM DISTANCE NEEDED TO BUFFER FROM TRANSIT STOPS AND COVER ALL FOCUS AREAS
# ASSUMES IN 1/2 or 1 MILE INTERVALS
buffer_max_distance = ceiling(max_min_BART_EB_dist)

# FUNCTION CREATING MULTIPLE RING BUFFERS FOR TRANSIT STOPS
# CYCLES THROUGH EACH DISTANCE ROW TO BUFFER & UNION
multiringbuffers_byrow = function(
  input.points, # BART Stops or any point
  buffer_distance=.5,
  buffer_max=5,
  # default fields & info for union
  union_default = data.frame(
    stop_id=c('ALL'),stop_nm=c('UNION'),
    route_count=c(0),routes=c(''))
){
  mile=5280
  # SEQUENCE VECTOR OF BUFFER RING LENGTHS
  buffer_distances = 
    seq(from=buffer_distance, 
        to=buffer_max, by=buffer_distance)
  
  # CYCLE THROUGH DISTANCES TO BUFFER EACH POINT
  # USE ST_DIFFERENCE TO CREATE RINGS
  # CREATE UNION ROW OF EACH DISTANCE
  for (current_buffer_distance in buffer_distances) {
    # GEOM OF SMALLER DISTANCE TO CREATE RING
    buffer.difference = 
      input.points %>% 
        st_buffer(
          (current_buffer_distance-buffer_distance)*mile
          ) %>% st_union() %>% st_sfc()
    # SF BUFFER OF EACH STOP
    buffer.new = 
      input.points %>%
      st_buffer(., current_buffer_distance*mile) %>%
        st_difference(., buffer.difference) %>%
      mutate(distance = current_buffer_distance)
    
    # SF BUFFER UNION FOR NEW ROW 
    buffer.union = 
      buffer.new %>%
        st_union() %>%
        st_difference(., buffer.difference) %>%
        st_sfc() %>%
      # cbind default union fields
      cbind(
        ., union_default %>%
          mutate(distance=current_buffer_distance)
        ) %>% st_as_sf() %>% 
      # reorder columns for rbind
      subset(., select=colnames(buffer.new))
    
    # rbind to all buffers
    if (current_buffer_distance==buffer_distance) {
      buffer.temp = 
        st_as_sf(rbind(
          buffer.union, 
          buffer.new))} 
    else 
      buffer.temp = 
      st_as_sf(rbind(
        buffer.temp, 
        buffer.union, 
        buffer.new))
  }
  # reset index
  row.names(buffer.temp) <- NULL
  return(buffer.temp)
}

buffer_distance = .5
BART.buffers = 
  multiringbuffers_byrow(
    BART.stops, buffer_distance=buffer_distance,
    buffer_max=buffer_max_distance)

buffer_distances = 
  seq(from=buffer_distance, to=buffer_max_distance, by=buffer_distance)

plot_limits = function(
  poly.geometry = EB.cities$geometry,
  # buffer between plot's limits and the geometry 
  # (in unit of geometry column)
  buffer = 0
){
  # creates bounding box
  poly.bbox =
    poly.geometry %>% st_union() %>%
    # buffers the geometry so the ultimate plot has margins
    st_buffer(buffer) %>%
    st_bbox()
  return(
    # returns the 'coord_sf' function which you can add to any plot
    coord_sf(
      xlim = c(poly.bbox['xmin'], poly.bbox['xmax']),
      ylim = c(poly.bbox['ymin'], poly.bbox['ymax']),
      crs = st_crs(poly.geometry)
  ))}

buffer_breaks = c(0,buffer_distances)
buffer_labels =
  c(gsub("0.", ".", buffer_breaks))
#buffer_breaks = c(buffer_distances,buffer_max_distance+buffer_distance)



```

### 1.B.1 American Community Survey Census Tracts (2009 & 2019)

*Loading Census Tracts & Variables*

```{r 1B1_Tracts, echo=FALSE, warning=FALSE}

# ACS VARIABLES TO FOCUS ON
acs_var = c(
  "B01001_001", # total pop
  # HOUSING
  "B19013_001", # median household income
  
  #"B25001_001", # housing units # SOMETHING WRONG
  #"B25008_001", # occupied housing units
  
  "B25058_001", # Median Contract rent
  "B25064_001", # Median gross rent
  "B25071_001", # median rent as percent of household income
  "B07003_001", # total
  "B07003_004", # total same house 1 year
  # TRAVEL
  "B08135_001", # aggregate time to work
  "B08135_010", # aggregate time to work over 60 mins
  # DEMOGRAPHIC
  "B01001_010", # Male Age    22 to 24
  "B01001_011", # Male Age    25 to 29
  "B01001_012", # Male Age    30 to 34
  "B01001_034", # Female Age  22 to 24
  "B01001_035", # Female Age  25 to 29
  "B01001_036"  # Female Age  30 to 34
  # THIS SECTION OF MY CODE IS DEDICATED TO THE VARIABLES THAT COULD HAVE BEEN STUDIED IF TIDY CENSUS DIDNT HAVE ERRORS WITH THESE TABLES
  # Rest In Pieces
  ## "B08201_001", # household size
  ## "B08201_002", # households with not vehicle
  ## "B24114_001", # total occupations
  ## "B24114_068"  # total software developers
  )

# preparing dummy housing fields
B07013_002 = 0
B07013_003 = 0
B25008_002 = 0
B25008_003 = 0

# FUNCTION TO PULL EACH ACS YEAR'S CENSUS TRACTS
get_acs_year <- function(acs_year) {
  # TIDY CENSUS PULL
  
  # add in housing variables per year (same fields but differing variable name/id)
  acs_var = c(acs_var,
          ifelse(acs_year==2019,
            c(
              "B07013_002", # 2019 owner lived in units
              "B07013_003" # 2019 renter lived in units
            ), c(
             "B25008_002", # 2009 owner lived in units
             "B25008_003" # 2009 renter lived in units
          )))
  
  tracts.acs =
     get_acs(
       geography = "tract",
       variables = acs_var,
       year=acs_year, state='CA', county='Alameda',
       geometry=T) %>%
     st_transform(CA_crs)
  
  # directory = 'C:/Users/nelms/OneDrive/Penn/MUSA-508/Files'
  # filename = gsub(" ","",paste('census', acs_year, '_tracts.geojson'))
  # tract_path = file.path(directory, filename)
  #   
  # tracts.acs = st_read(tract_path) 
  
  tracts.acs = 
    tracts.acs %>%
    dplyr::select( -NAME, -moe) %>%
    spread(variable, estimate)
  # GROUP BY GEOID TO FIX MULTIPOLYGON ISSUE
  tracts.acs =
    tracts.acs %>%
    group_by(GEOID) %>%
    summarise(
      year          = acs_year,
      tot_pop       = first(B01001_001), 
      med_HH_inc    = first(B19013_001),
      med_rent      = first(B25058_001),
      med_rent_util = first(B25064_001),
      tot_units     = ifelse(acs_year==2019,
          first(B07013_002)+first(B07013_003),
          first(B25008_002)+first(B25008_003)),
      pct_60m_commute = first(B08135_010) / first(B08135_001), 
      tot_22_34yo   = first(B01001_010) + first(B01001_011) + first(B01001_012) 
        + first(B01001_034) + first(B01001_035) + first(B01001_036),
      pct_22_34yo   = tot_22_34yo/first(B01001_001),
      tot_moved     = first(B07003_001) - first(B07003_004),
      pct_moved     = tot_moved/first(B07003_001),
      pct_med_rent  = first(B25071_001),
      geometry      = st_union(geometry), # turn to multipoly
        # median contract rent (just rent) adjusted by 2019 inflation
      med_rent_inf = 
        ifelse(acs_year == 2009, med_rent * 1.19, med_rent),
      # median gross rent (rent + utilities) adjusted for inflation
      med_rent_util_inf = 
        ifelse(acs_year == 2009, med_rent_util * 1.19, med_rent_util),
      # median rent (in 2009) adjusted by 2019 inflation
      med_HH_inc_inf = 
        ifelse(acs_year == 2009, med_HH_inc * 1.19, med_HH_inc)
      )
  # REMOVE RAW ACS FIELDS
  non_raw_cols = 
    colnames(tracts.acs)[!startsWith(colnames(tracts.acs), "B")]
  tracts.acs = tracts.acs[non_raw_cols]
  
  return (tracts.acs)
}

# ADD ACS EMPLOYMENT FIELDS THAT TIDYCENSUS WOULDN'T IMPORT
get_acs_subinfo = function(acs_year){
  # local csv
  directory = 'C:/Users/nelms/OneDrive/Penn/MUSA-508/Files'
  filename = gsub(" ","",paste('census', acs_year, '_employment.csv'))

  focus_year = read.csv(file=file.path(directory, filename))
  
  focus_year$GEOID = sapply(focus_year$GEOID, function(g) paste('0', as.character(g), sep=''))
  focus_year = 
    focus_year[focus_year$GEOID != '0NA',]
  
  
  return(focus_year)
}

tracts.all = rbind(
  get_acs_year(2009), 
  get_acs_year(2019)
  ) %>% st_as_sf()


tracts.info = 
  rbind(
    get_acs_subinfo(2009), 
    get_acs_subinfo(2019))

tracts.all = merge(
  tracts.all,
  tracts.info,
  by = c('GEOID','year'),
  all.x = TRUE) %>%
  st_as_sf()

```

### 1.B.2 Narrowing to the East Bay

*Select Tracts & Routes, Clip by Water, Calculate Variables*

```{r 1B2_EastBay, echo=FALSE}

# CREATE ERASE FUNCTION
st_erase <- function(x, y) {
  st_difference(x, st_union(y))}

# ERASE WATER AREAS FROM CENSUS TRACTS
EB.water =
  area_water("CA", "Alameda", class = "sf") %>%
  st_transform(., CA_crs)
tracts.all <- st_erase(tracts.all, EB.water)

# GET CENTROIDS IN EAST BAY
tracts.all.centroid =
  tracts.all[c('GEOID','geometry')] %>%
  # centroid with largest poly to avoid water in city shapes
  st_centroid(tracts.all, of_largest_polygon = TRUE) %>%
  st_join(., EB.cities, left=TRUE) %>%
  distinct(GEOID, .keep_all = TRUE)
tracts.all.centroid = 
  tracts.all.centroid[tracts.all.centroid$city %in% is_EB,]
# SELECT TRACTS BY EAST BAY
center_geoms = tracts.all.centroid$GEOID
tracts.all = tracts.all[tracts.all$GEOID %in% center_geoms,]

# ERASE CITIES BY WATER
EB.cities <- st_erase(EB.cities, EB.water)

min_BART_dist_find = function(tract.pt){
  dists_bart = sapply(
    BART.stops$geometry, function(BART_pt) 
    st_distance(BART_pt, tract.pt))
  return(min(dists_bart))
}

tract_bart_distances = min_point_distances(
  tracts.all.centroid$geometry, tracts.all.centroid$GEOID,
  BART.stops$geometry, BART.stops$stop_id) %>%
  rename(GEOID=ID, dist_BART=distance, closest_BART=closest)

tracts.all.centroid = 
  tracts.all.centroid %>%
  merge(
    ., 
    tract_bart_distances,
    by='GEOID', all.x = TRUE
  )

# CALCULATE NEW COLUMNS BY WEIGHTING & LQ
tracts.all =
  tracts.all %>%
  merge(
    ., 
    tracts.all.centroid %>% as.data.frame() %>% 
      select(GEOID, city, dist_BART, closest_BART) %>%
      rename(dist_BART_feet=dist_BART) %>%
      distinct(.),
    by='GEOID', all.x = TRUE) %>% 
  mutate(
    # distance to BART by miles
    dist_BART_miles=dist_BART_feet/mile,
    # area of tract that's not water
    land_area   = st_area(geometry),
    # total population over housing units
    pop_units = ifelse(tot_units==0, NA,
                       tot_pop / tot_units),
    # get percent of employees in information industry
    pct_emp_info = (tot_emp_info / tot_emp)*100
  )

attributes(tracts.all$land_area) = NULL
# population per sq mile
tracts.all$dens_pop    = tracts.all$tot_pop/(tracts.all$land_area/sqmile)
# housing units per sq mile
tracts.all$dens_units  = tracts.all$tot_units /(tracts.all$land_area/sqmile)


selects = c("06001401900","06001402000","06001402200", "06001981900", "06001982000")
# for (yr in c(2019,2009)){
#   tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp),
#              'tot_EB_emp'] = sum(tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp)
#                                             ,][['tot_emp']])
#   tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp_info),
#              'tot_EB_emp_info'] = sum(tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp_info)
#                                                  ,][['tot_emp_info']])
#   # LOCATION QUOTIENT for information industry employees in the East Bay area
#   tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp),] = 
#     tracts.all[tracts.all$year==yr & !is.na(tracts.all$tot_emp),] %>%
#     mutate(
#       lq_emp_info = 
#         # ratio of info employees to total for tracts "local"
#         (tot_emp_info/tot_emp) / 
#         # ratio of info o total for East Bay "regional"
#         (tot_EB_emp_info / tot_EB_emp)
#     )}

BART.stops =
  BART.stops %>%
  mutate(
    lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
    lat = map_dbl(geometry, ~st_centroid(.x)[[2]]),
    stop_nm = gsub("St. Oakland.*", "St", stop_nm)
  )


buff_plot = 
  ggplot() + 
    geom_sf(
      data=EB.cities, fill='grey90') + 
    geom_sf(
      data=BART.routes, color='grey20', 
      alpha=.5, lwd=1.5) + 
    geom_sf(
      data=BART.buffers[BART.buffers$stop_id=='ALL',],
      fill='transparent', aes(color=distance), lwd=.75) + 
    geom_sf(
      data=BART.stops, fill='white',
      color='grey30', shape=21) + 
    scale_color_stepsn(
      #labels = buffer_labels,
      breaks = buffer_breaks,
      colors=brewer.pal(length(buffer_breaks),
                        name='Spectral'), guide='none') + 
    labs(subtitle='½ Mile Buffer from Stations', caption='Figure 1.A.3') + 
    mapTheme() + plot_limits()

tracts_tracks = 
  ggplot() +
    # base tracts
    geom_sf(data=tracts.all, size=.5,
            color='grey80', fill='grey90') +
    # cities
    geom_sf(data=EB.cities, fill='transparent', 
            color=alpha('grey50',.5),
            lwd=1, linetype = "dashed") + 
    # centroids
    # geom_sf(data=tracts.all.centroid, color='grey50', size=.5) +
    # BART routes
    geom_sf(data=BART.routes, color=BART.routes$route_s_nm, lwd=1.5) + 
    # BART stops
    geom_sf(data=BART.stops, fill='white',
            color='grey30', shape=21) + 
    # labels
    geom_label(
      data=EB.labels,
      size = 2, fontface='bold', color='grey20', label.size = NA,
      box.padding = 0.5, fill=alpha('white',.5),
      aes(x=lon,y=lat, label=label)) + 
    labs(subtitle = 'Cities, Tracts & Routes', caption='Figure 1.B.1') +
    mapTheme() + plot_limits()


nearest_stop = 
  ggplot() +
    # base tracts
    geom_sf(data=tracts.all, size=.5,
            color='grey80', fill='grey90') +
    # Tracts BART
    geom_sf(
      data=tracts.all[tracts.all$year==2019,], color=alpha('black',.1),
      aes(
        fill=tracts.all[tracts.all$year==2019,]$closest_BART, 
        alpha=tracts.all[tracts.all$year==2019,]$dist_BART_miles)) + 
    # BART stops
    geom_sf(data=BART.stops,
            color='black', shape=19, size=1) + 
    # labels
    geom_label_repel(
      data=BART.stops,
      size = 2, fontface=2, color='grey20', label.size = NA,
      fill=alpha('white',.5),
      aes(x=lon,y=lat, label=stop_nm)) + 
    scale_fill_discrete(name="Closest BART", guide='none') + 
    labs(subtitle = 'Closest Station to each Tract', caption='Figure 1.B.2') +
    scale_alpha_continuous(breaks=c(.5,1,1.5,2), name="Distance", range=c(1,0), guide='none') + 
    mapTheme() + plot_limits()

tracts_tracks + buff_plot + nearest_stop + plot_annotation(title='East Bay Census Tracts & BART')



```

## 1.B.3 Finding TOD Areas

*Buffering Transit (BART) Stops then Select Census Tracts by Area in TOD*

```{r 1B.3_TOD, echo=FALSE}

#tracts.all = st_as_sf(at)

# .5 MILE BUFFERS OF BART STOPS
BART.buffers.TOD = 
  BART.buffers[
    BART.buffers$distance == buffer_distance &
      BART.buffers$stop_id == 'ALL'
  ,]

# CLIP TRACTS BY BUFFER
clip = 
  st_intersection(tracts.all, BART.buffers.TOD) %>%
    select(GEOID, year, land_area) %>% 
    group_by(GEOID, year) %>%
      summarize(
        geometry = st_union(geometry),
        land_area = sum(land_area)
      ) %>% 
    mutate(
      # find area that is in the buffer
      clip_area = as.vector(st_area(geometry)),
      # percent of buffer area to total
      pct_in_tod = as.vector(clip_area / land_area),
      Selection_Type = "Clip")
clipped = clip[c("GEOID", "year", "pct_in_tod","clip_area")]
clipped$geometry = NULL

# GET TOTAL & PERCENT LAND IN CLIP
tracts.all = 
  merge(tracts.all, 
        clip %>% st_drop_geometry() %>% select(GEOID, year, pct_in_tod, clip_area), 
        by = c("GEOID","year"), all.x = TRUE)
tracts.all[is.na(tracts.all$clip_area), 'clip_area'] = 0
tracts.all[is.na(tracts.all$pct_in_tod), 'pct_in_tod'] = 0

# GET OTHER SELECTIONS FOR COMPARING
selection = 
  tracts.all[BART.buffers.TOD,] %>%
    dplyr::select(GEOID, pct_in_tod) %>%
    mutate(
      Selection_Type = "Spatial Selection")

selectCentroids =
  tracts.all.centroid[BART.buffers.TOD,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(tracts.all, GEOID, pct_in_tod)) %>%
    st_sf() %>%
    mutate(Selection_Type = "Centroid Selection")

# NARROW DOWN TOD TRACTS BASED ON CLIPPED STOPS BUFFER AREA (% and TOT)
tracts.all = tracts.all %>%
  mutate(
    TOD = if_else(
      # select tracts that had 50% of their land in .5mi stops buffer
      ((
        tracts.all$pct_in_tod>=.5
        ) |
      # select tracts that had:
      ( ### at least 20% of their land in the buffer, and
        (tracts.all$pct_in_tod>.25) &
        ### at least .01 sq.miles (278,784 )
        (tracts.all$clip_area>sqmile*.075)
      ) | (tracts.all$GEOID %in% selects)),
      'TOD',
      'Non-TOD'
    ))
tracts.TOD = tracts.all[tracts.all$TOD=='TOD',]

ggplot() +
  geom_sf(
    data=EB.cities %>% st_union(), fill='grey90') +
  geom_sf(data=clip, aes(fill=pct_in_tod)) +
  geom_sf(data=selection, aes(fill=pct_in_tod)) +
  geom_sf(data=selectCentroids, aes(fill=pct_in_tod)) +
  geom_sf(data=BART.buffers.TOD, fill='transparent', color='red', lwd=1) +
  geom_sf(data=tracts.TOD %>% filter(year==2019) %>% st_union(), 
          fill='transparent', aes(color='Black'), lwd=1)+ 
  geom_sf(
    data=BART.stops, fill='white',
    color='grey30', shape=21) + 
  scale_fill_steps2(
    low = "red",
    mid = "white",
    midpoint=.5,
    high = "blue",
    name='% of land area\nwithin ½ Mile Station Buffer',
    labels = percent, limits = c(0,1)
  ) + 
  scale_color_identity(guide = "legend", name='TOD Tracts', labels=c('Primarily within ½ Mile Buffer*')) + 
  facet_wrap(~Selection_Type) + 
  labs(title='Selecting Transit Oriented Development Census Tracts',
       subtitle = "TOD Tracts have 50% of their Total Area within the ½ Mile Station Buffer\nor 25% of their Total Area (when the Buffer Area is at least .075 square miles)", caption="* Either the Tract's Buffer Area is 50% of Total Area or 25% of Total Area, if the Buffer Area is greater than .075 square miles\nFigure 1.B.3")+
  mapTheme() + plot_limits(poly.geometry = BART.buffers.TOD, buffer=mile*.25)

```
### 1.D.1 Crime Data

Crime

```{r 1D_Crime, echo=FALSE}
library(zoo)

OAK.311.path = "C:/Users/nelms/OneDrive/Penn/MUSA-508/Files/OAK_311.csv"
OAK.311 = read.csv(OAK.311.path) %>%
  rename(
    id = REQUESTID,
    date_in = DATETIMEINIT,
    description = DESCRIPTION,
    category = REQCATEGORY,
    geom = REQADDRESS,
    address = PROBADDRESS,
    lat = SRY,
    long = SRX
    ) %>%
  mutate(
    datetime = mdy_hms(date_in, quiet=TRUE, tz = "America/Los_Angeles"),
    date = datetime %>% as.Date(),
    year_qtr = date %>% as.yearqtr(),
    year = format(date, "%Y"),
    cat = sub("\\_.*", "", category),
    description = sub(" in | on | ï¿½ | â€“ |\\\\|/| [(]", " - ", description) %>%
      sub("TE ", "Traffic ", .) %>%  sub("Oakland Police - Abandoned Auto", "Abandoned Auto", .) %>% str_trim(.),
    desc = sub("\\-.*", "", description) %>% 
      gsub("(Traffic).*", "\\1", .) %>% gsub("(Recycling).*", "\\1", .) %>% 
      gsub("(Oakland Police).*", "\\1", .) %>% gsub("(Trash).*", "\\1", .) %>% 
      str_trim(.)
    ) %>% 
  filter(
    desc %in% c("Illegal Dumping", "Homeless Encampment"),
    !is.na(lat) & !is.na(long),
    (lat>0) & is.numeric(lat),
    (long>0) & is.numeric(long),
    (is.POSIXct(datetime))
    ) %>%
  select(id, datetime, date, year, year_qtr, desc, lat, long) %>%
  st_as_sf(., coords = c('long','lat'), crs=CA_crs) %>% arrange(datetime) 

OAK.311 = 
  st_join(OAK.311, EB.cities[EB.cities$city=='Oakland',],
          join=st_intersects) %>% filter(city=="Oakland") %>% select(-size)

OAK.311[OAK.311$year_qtr %in% c(unique(OAK.311$year_qtr)[3], unique(OAK.311$year_qtr)[3]), "year"] = "2009"

OAK.311 = OAK.311 %>% filter(year %in% c("2009","2014", "2019"))

# ggplot(OAK.311, 
#        aes(x=year_qtr %>% as.Date(), group=desc, fill=desc)
#        ) +
#       stat_bin(
#        color="black")

```

### 1.D.2 Set Zone

Crime

```{r 1.D.1_years}

get_base_tracts = function(acs_year, acs_var_base=c("B25064_001")){
  tracts.acs =
     get_acs(
       geography = "tract",
       variables = acs_var_base,
       year=acs_year, state='CA', county='Alameda',
       geometry=T) %>%
     st_transform(CA_crs)

  tracts.acs = 
    tracts.acs %>%
    dplyr::select( -NAME, -moe) %>%
    spread(variable, estimate) 
  
  tracts.acs =
    tracts.acs %>%
    rename(med_rent = B25064_001) %>%
    mutate(
      med_rent_inf = 
        ifelse(acs_year == 2009, med_rent * 1.19, 
          ifelse(acs_year == 2014, med_rent * 1.08,
             med_rent)),
      year = acs_year %>% as.character())
  
  return(tracts.acs)}


tracts.OAK = rbind(
  get_base_tracts(2009),
  get_base_tracts(2014),
  get_base_tracts(2019)
  ) %>% st_as_sf()

glimpse(tracts.OAK)

ggplot() + 
  geom_sf(data=EB.cities) + 
  geom_sf(data=OAK.311.join) + 
  plot_limits(poly.geometry = EB.cities[EB.cities$city=='Oakland',])

```


------------------------------------------------------------------------

## 2 Four Time & Space Maps

***Comparing TOD & non-TOD Tracts between 2000 & 2019***

Median Rent, [Second], [Third], [Fourth]

### 2.A People per Unit

*Total Population per Occupied Housing Units*

```{r 2A_variable1, echo=FALSE}
options(scipen=999)

get_labels = function(
  cut_breaks, round_digit = 0, bucket_diff=1, first_start_range=0, last_end_range=TRUE, input_end_range='', bucket_suffix='', bucket_prefix=''
){
  labels = 
    cut_breaks %>% gsub(",", " to ", .) %>% 
    str_sub(., 2, -2) %>% unique(.)
  
  list_str = function(l, remove=0){
      format(round(as.numeric(l), digit=round_digit)-remove, big.mark=",")}
  
  for (i in seq(from=1,to=length(labels))){
    bucket_range = labels[i] %>% str_split(., " to ")
    
    start_range = paste(bucket_prefix, list_str(bucket_range[[1]][1]))
    end_range = paste(list_str(bucket_range[[1]][2], remove=bucket_diff), bucket_suffix)
    
    if (i == 1 & first_start_range != ''){
      start_range = paste(bucket_prefix, list_str(first_start_range))}
    if (i == length(labels) & input_end_range!=''){
      end_range=paste(list_str(input_end_range), bucket_suffix)
      last_end_range=TRUE
      }
    if (i == length(labels) & last_end_range==FALSE){end_range='+'}
    
    bucket = paste(
        start_range, 
        'to', 
        end_range) %>% str_trim()
    labels[i] = bucket}
    
  return(labels)
  }


plot_vari = function(
  focus_sf  = tracts.all,
  variable  = "dens_pop",
  qbreaks   = qBr(tracts.all, variable),
  bucket_diff = 1,
  title     = "Population Density 2009-2019", 
  subtitle  = "East Bay with ½ mile buffer from BART stations",
  legend_nm = variable,
  caption   = "Figure 2.A",
  brewer_colors = 'Spectral',
  round_digit = 0,
  last_end_range = TRUE,
  input_end_range = '',
  bucket_suffix = '',
  buff_col = 'red',
  col_rev = FALSE,
  first_start_range = 0
){

cutting_field = function(var_field, var_breaks){return(var_field %>% cut(., breaks = var_breaks, dig.lab=10, include.lowest = TRUE))}

focus_sf$cut_field = cutting_field(focus_sf[[variable]], qbreaks)
  
cut_breaks = sapply(focus_sf$cut_field, function(brk) brk %>% levels())

labels = get_labels(
  cut_breaks, 
  round_digit = round_digit, bucket_diff=bucket_diff, 
  last_end_range=last_end_range, first_start_range=first_start_range, 
  input_end_range=input_end_range, bucket_suffix=bucket_suffix)

breaks_amount = length(qbreaks)-1
col_vals = brewer.pal(breaks_amount, name=brewer_colors)

if (col_rev==TRUE){col_vals=rev(col_vals)}

return(
ggplot()+
  # geom_sf(data = EB.all, fill=alpha('grey50', .5), color=alpha('grey50', .5)) + 
  # geom_sf(data = EB.back_water, fill=alpha('cornflowerblue', .5), color='transparent') + 
  geom_sf(data  = EB.cities, fill='grey90')+
  geom_sf(data  = focus_sf, aes(fill    = cut_field), color='grey50') +
  
  scale_fill_manual(
    values=col_vals,
    labels = labels, name=legend_nm) +
  geom_sf(data=BART.buffers.TOD, fill='transparent', color=alpha(buff_col, alpha=.75), lwd=.75) +
  geom_sf(
    data=BART.stops, fill='white',
    color='grey30', shape=21) + 
  # geom_text(
  #   data=EB.labels, check_overlap=TRUE,
  #   size = 3.5, fontface='bold', color='black',
  #   aes(x=lon,y=lat, label=label)) + 
  labs(title = title, subtitle = subtitle,
       caption=caption) +
  guides(fill = guide_legend(reverse=T)) + 
  facet_wrap(~year)+
  mapTheme() + plot_limits()
)}

variable  = "pop_units"

filt_sf = tracts.all[!is.na(tracts.all[[variable]]) &
                      !is.infinite(tracts.all[[variable]])
                       ,]
mx = max(filt_sf[[variable]])

breaks = c(0,1.5,2,4,20, mx)
#breaks = seq(0, mx, length.out = 4)

plot_vari(
  focus_sf  = filt_sf,
  variable  = variable,
  qbreaks   = breaks,
  title     = "People per Units 2009-2019", 
  caption   = "Figure 2.A",
  brewer_colors = 'BuPu',
  legend_nm = "People per Units",
  bucket_suffix = '',
  input_end_range = '200',
  last_end_range = FALSE,
  round_digit=2,
  bucket_diff=.1,
  first_start_range=1
)

```

### 2.B Income spent on Rent
*Percent of Median Household Income spent on Rent*

```{r 2B_variable2}

variable  = "pct_med_rent"

filt_sf = tracts.all[!is.na(tracts.all[[variable]]) &
                      !is.infinite(tracts.all[[variable]])
                       ,]


mx = max(filt_sf[[variable]])
#breaks = seq(0, mx, length.out = 6)
#breaks = c(0, 10000,20000,30000, mx)
breaks = c(0, 10,20,30,40, mx)

plot_vari(
  focus_sf  = filt_sf,
  variable  = variable,
  qbreaks   = breaks,
  title     = "Percent of Income Spent on Rent 2009-2019", 
  caption   = "Figure 2.B",
  brewer_colors = 'RdYlGn',
  legend_nm = "% of Median Income\nSpent on Rent",
  input_end_range='50',
  bucket_suffix='%',
  col_rev=TRUE,
  buff_col='blue'
)

```

### 2.C People Who Recently Moved
*Percent of People who were in a different house in the last year compared to total people*

```{r 2C_variable3}

variable  = "pct_moved"

filt_sf = tracts.all %>%   
  transform(., pct_moved=as.numeric(pct_moved)) %>%
  filter(!is.na(tracts.all[[variable]]) &
                      !is.infinite(tracts.all[[variable]]))

filt_sf[[variable]] = filt_sf[[variable]] * 100
mx = max(filt_sf[[variable]])
#breaks = seq(0, mx, length.out = 5)
breaks = c(0, 15, 30, 45, mx)

filt_sf$cut_field = 
  filt_sf[[variable]] %>% 
  cut(., 
      breaks = breaks, dig.lab=10, include.lowest = FALSE)

plot_vari(
  focus_sf  = filt_sf,
  variable  = variable,
  qbreaks   = breaks,
  bucket_diff=1,
  round_digit=2,
  title     = "Percent of Population that Moved in Last Year 2009-2019", 
  caption   = "Figure 2.C",
  brewer_colors = 'PuRd',
  legend_nm = "% of Population that did not\nreside in their current house\n a year ago",
  input_end_range='90',
  bucket_suffix='%',
  col_rev=FALSE
)

```

### 2.D People in the Information Industry

*Percent of Employed People in the Information Industry (e.g. Technology, Software) compared to Total Employed People*

```{r 2D_variable4}

variable  = "pct_emp_info"

filt_sf = tracts.all %>%   
  mutate(pct_22_34yo = pct_22_34yo * 100) %>%
  filter(!is.na(tracts.all[[variable]]) &
         !is.infinite(tracts.all[[variable]]))

mx = max(filt_sf[[variable]])
# Break reasons: min, right below mean/median (3.7%, 3.5%), above 3rd quantile, odd spike around 9-10%, max
breaks = c(0, 3, 6, 9, mx)

plot_vari(
  focus_sf  = filt_sf,
  variable  = variable,
  qbreaks   = breaks,
  bucket_diff=1,
  round_digit=0,
  title     = "Percent of Employed Residents in the Information Industry 2009-2019", 
  caption   = "Figure 2.D",
  brewer_colors = 'OrRd',
  legend_nm = "% of Information Industry Employees\n(e.g. Technology, Software, Media)\nout of all Employed Residents",
  input_end_range='25',
  bucket_suffix='%',
  buff_col='Black'
)

```

------------------------------------------------------------------------

## 3 Bar Plot

*One grouped bar plot making these same comparisons*

```{r 3_barplot, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}

tracts.summary =
  tracts.all %>% st_drop_geometry() %>%
    mutate(
      year = as.character(year),
      pct_moved = pct_moved*100
           ) %>%
    group_by(year, TOD) %>%
    summarize(
      # Variable B  Population
      Population    = mean(tot_pop, na.rm = T),
      # Variable A  Rent (Inflation)
      y_Median_Rent   = mean(med_rent_util_inf, na.rm = T),
      # Variable 1  Popultion per Unit
      yy_Pop_per_Unit  = mean(ifelse(pop_units>50, NA, pop_units), na.rm = T),
      # Variable 2  % Income Spent on Rent 
      z_Income_Rent_per = mean(pct_med_rent, na.rm = T),
      # Variable 3  % Moved in Last Year
      zz_Moved_per     = mean(pct_moved, na.rm = T),
      # Variable 4
      zzz_Info_per      = mean(pct_emp_info, na.rm = T))

plot_names = list(
  'Population'  = "Population",
  'y_Median_Rent' = "Median Rent\n& Utilities",
  'yy_Pop_per_Unit'= "Population\nper Housing Unit",
  'z_Income_Rent_per'="% of Income\n Spent on Rent",
  'zz_Moved_per'   = "% that Moved\nthis Year",
  'zzz_Info_per'    = "% Information\nEmployees"
)
plot_labeller <- function(variable, value){return(plot_names[value])}
col_labeller <- function(Variable, value){return(as.character(plot_names[value]))}

tot_levels = c('Population', 'z_Median_Rent', 'zz_Pop_per_Unit')
per_levels = c('Income_Rent_per', 'Moved_per', 'Info_per')
all_levels = c(tot_levels, per_levels)
total_bars = 
  tracts.summary %>%
  select(-z_Income_Rent_per, -zz_Moved_per, -zzz_Info_per) %>%
    gather(Variable, Value, -year, -TOD) %>% 
    #mutate(Variable=factor(Variable, levels=tot_levels)) %>%
  ggplot() +
    geom_bar(stat = "identity", position = "dodge", 
             aes(year, Value, fill = TOD)) +
    facet_wrap(Variable ~ .,
              #~reorder(Variable, all_levels, first),   
               #~factor(Variable, levels = tot_levels),
               scales = "free", ncol=3, 
               labeller=plot_labeller,
               ) +
    scale_fill_manual(values = c("#bae4bc", "#0868ac"), guide='none') + 
    labs(x=NULL, y=NULL) +
    theme(panel.spacing = unit(1, "lines")) + 
    plotTheme()


percent_bars = 
  tracts.summary %>%
  select(-Population, -y_Median_Rent, -yy_Pop_per_Unit) %>%
    gather(Variable, Value, -year, -TOD) %>% 
    #mutate(Variable=factor(Variable, levels=per_levels)) %>%
  ggplot() +
    geom_bar(stat = "identity", position = "dodge", 
             aes(year, Value, fill = TOD)) +
    facet_wrap(~Variable,
               #~reorder(Variable, all_levels, first),         
               #~factor(Variable, levels = per_levels),
               scales = "free", ncol=3, 
               labeller=plot_labeller
               ) +
    scale_fill_manual(values = c("#bae4bc", "#0868ac")) +
    labs(x=NULL, y=NULL) +
    theme(panel.spacing = unit(1, "lines")) + 
    scale_y_continuous(labels = function(x) paste0(x, "%")) + 
    plotTheme() + theme(legend.position="bottom")


total_bars / percent_bars +
  plot_annotation(title = "Differences Between TOD Tract's Variables in 2009 & 2019",
                  caption = "") + plotTheme() 

```

------------------------------------------------------------------------

## 4 Table

*One table making these same comparisons*

```{r 4_table, results="asis"}

plot_names = list(
  'Population'  = "Population",
  'y_Median_Rent'        = "Median Rent & Utilities(Adjusted)",
  'yy_Pop_per_Unit'= "Population per Housing Unit",
  'z_Income_Rent_per'="% of Income Spent on Rent",
  'zz_Moved_per'   = "% of Population that Moved this Year",
  'zzz_Info_per'    = "% of Population in the Information Industry"
)

col_labeller = function(value){return(as.character(plot_names[value]))}
rounder = function(value, colname){return(paste(
  ifelse(str_sub(colname,1,4)=='z_Median_Rent', '$ ', ''),
  format(round(value, digit = ifelse(value>31,0,2)),drop0trailing=TRUE, big.mark=","),
  ifelse(str_sub(colname,-4,-1)=='_per', ' %', ''), sep=''))}

tracts.table = 
  tracts.summary %>%
    unite(year.TOD, year, TOD, sep = ": ", remove = T) %>%
    gather(Variable, Value, -year.TOD) %>%
    mutate(Value = rounder(Value,Variable)) %>%
    spread(year.TOD, Value) %>%
    arrange(., Variable) %>%
    mutate(Variable=col_labeller(Variable)) %>%
    # mutate(Variable = factor(Variable, levels =c("Population","Median Rent & Utilities(Adjusted)","Population per Housing Unit","% of Income Spent on Rent","% of Population that Moved this Year","% of Population in the Information Industry"))) %>%
    kable(., col.names = c("Mean Variables","non-TOD","TOD","non-TOD","TOD"), align="lrrrr") %>%
      kable_styling() %>%
      footnote(general_title = "\n", general = "Table 1.3") %>% 
      add_header_above(., header = c(" "=1, "2009" = 2, "2019" = 2))
 #col.names = c("","2009","2009","2019","2019")
tracts.table

```

------------------------------------------------------------------------

## 5 Graduated Symbol Maps

*Two Graduated Symbol Maps within 0.5 miles transit stations*

### 5.A Map of Population within ½ Mile of BART Stations

```{r 5A_pop}

variable = 'tot_pop'

brewer_colors = 'Purples'

plot_title = "Total Population within ½ Mile of BART Stations"
legend_title = "Total Population"
subtitle = "East Bay Census Tracts & BART Stations"
caption = "Map 5.A"

filt_sf = tracts.all[!is.na(tracts.all[[variable]]) &
                    !is.infinite(tracts.all[[variable]]) & 
                     (tracts.all$TOD=='TOD')
                       ,]

mx = max(filt_sf[[variable]])

qbreaks = c(0, 1000,2500,5000,7500, mx)
#qbreaks = seq(0, mx, length.out = 7)

cutting_field = function(var_field, var_breaks){return(var_field %>% cut(., breaks = var_breaks, dig.lab=10, include.lowest = TRUE))}

filt_sf$cut_field = cutting_field(filt_sf[[variable]], qbreaks)
  
cut_breaks = sapply(filt_sf$cut_field, function(brk) brk %>% levels())

labels = get_labels(
  cut_breaks, 
  round_digit = 0, 
  bucket_diff = 1, 
  last_end_range  = TRUE,
  first_start_range   = '', 
  input_end_range = '10000', 
  bucket_suffix = '')

breaks_amount = length(qbreaks)-1
col_vals = brewer.pal(breaks_amount, name=brewer_colors)

ggplot()+
  #POLYGON
  geom_sf(data = tracts.all,fill = "white",color = "grey75")+
  geom_sf(
    data=BART.buffers.TOD, 
    fill='transparent', color='red', lwd=1) +
  geom_sf(
    data=tracts.TOD %>% filter(year==2019) %>% st_union(),
    fill='transparent', color='Black', lwd=1)+ 
  geom_sf(
    data=BART.stops, fill='white',
    color='grey30', shape=21) + 
  # POINT
  geom_sf(data = filt_sf  %>% st_centroid(),
          shape = 21, color='grey10',
          aes(size = cut_field,fill = cut_field)) +
  scale_size_manual(
          values = seq(1, 6, length.out = breaks_amount),
          labels = labels, 
          name=legend_title)+
  scale_fill_manual(
      values = col_vals,
      labels = labels, 
      name='Total Population', guide='none') +
  labs(title = plot_title,
       subtitle = subtitle,
       caption = caption) +
  guides(size = 
      guide_legend(override.aes = list(fill = col_vals))) + 
  theme(axis.title=element_blank(),axis.text=element_blank(), axis.ticks=element_blank(), panel.background = element_rect(fill='gray')) +
  facet_wrap(~year)+
  mapTheme() + plot_limits(tracts.TOD %>% filter(year==2019), buffer=mile*.5)

```

### 5.B Map of Rent within ½ Mile of BART Stations

```{r 5B_rent}

variable = 'med_rent_util_inf'

brewer_colors = 'Greens'

plot_title = "Median Gross Rent within ½ Mile of BART Stations"
legend_title = "Median Rent + Utilities\n(Adjusted to 2019 Inflation)"
subtitle = "East Bay Census Tracts & BART Stations"
caption = "Map 5.B"

filt_sf = tracts.all[!is.na(tracts.all[[variable]]) &
                    !is.infinite(tracts.all[[variable]]) & 
                     (tracts.all$TOD=='TOD')
                       ,]

mx = max(filt_sf[[variable]])

qbreaks = c(0, 750, 1500, 2000, mx)
#qbreaks = seq(0, mx, length.out = 6)

cutting_field = function(var_field, var_breaks){return(var_field %>% cut(., breaks = var_breaks, dig.lab=10, include.lowest = TRUE))}

filt_sf$cut_field = cutting_field(filt_sf[[variable]], qbreaks)
  
cut_breaks = sapply(filt_sf$cut_field, function(brk) brk %>% levels())

labels = get_labels(
  cut_breaks, 
  round_digit = 0, 
  bucket_diff = 1, 
  last_end_range  = TRUE,
  first_start_range  = '', 
  input_end_range = '3500', 
  bucket_suffix = '',
  bucket_prefix = '$')

breaks_amount = length(qbreaks)-1
col_vals = brewer.pal(breaks_amount, name=brewer_colors)

ggplot()+
  #POLYGON
  geom_sf(data = tracts.all,fill = "white",color = "grey75")+
  geom_sf(
    data=BART.buffers.TOD, 
    fill='transparent', color='red', lwd=1) +
  geom_sf(
    data=tracts.TOD %>% filter(year==2019) %>% st_union(),
    fill='transparent', color='Black', lwd=1)+ 
  geom_sf(
    data=BART.stops, fill='white',
    color='grey30', shape=21) + 
  # POINT
  geom_sf(data = filt_sf  %>% st_centroid(),
          shape = 21, color='grey10',
          aes(size = cut_field,fill = cut_field)) +
  scale_size_manual(
          values = seq(1, 6, length.out = breaks_amount),
          labels = labels, 
          name=legend_title)+
  scale_fill_manual(
      values = col_vals,
      labels = labels, 
      name='Total Population', guide='none') +
  labs(title = plot_title,
       subtitle = subtitle,
       caption = caption) +
  guides(size = 
      guide_legend(override.aes = list(fill = col_vals))) + 
  theme(axis.title=element_blank(),axis.text=element_blank(), axis.ticks=element_blank(), panel.background = element_rect(fill='gray')) +
  facet_wrap(~year)+
  mapTheme() + plot_limits(tracts.TOD %>% filter(year==2019), buffer=mile*.5)


hist(filt_sf[[variable]], breaks=20)
```

------------------------------------------------------------------------

## 6 Geom Line Plots

***Rent & Crime compared to the Distance to BART stations***

```{r 6_geom_line}

glimpse(tracts.all)


```

------------------------------------------------------------------------

## 7 Policy Brief

------------------------------------------------------------------------

## Load data from {tidycensus}

```{r acs_vars, cache = TRUE, message = FALSE, warning = FALSE, results=FALSE}
acs_vars <- c(
    "B01001_001",    # ACS total Pop stimat
    "B15003_001",
    "B25002_001",     # stimat of total housing units
    "B25002_003",     # Numbr of vacant housing units
    "B19013_001",    # Mdian HH Incom ($)
    "B02001_002",  # Popl dscribing thmslvs as "whit alon"
    "B07010_001",     # stimat!!Total Individuals
    "B07010_002",  # stimat!!Total:!!No incom
    "B07010_011", # stimat!!Total:!!With incom:!!$75,000 or mor
    "B07010_023",   # stimat!!Total:!!Movd within sam county:
    "B07010_034",  # stimat!!Total:!!Movd from diffrnt county:
    "B07010_045",   # stimat!!Total:!!Movd from diffrnt country:
    "B07010_012",  # Estimate!!Total:!!Same house 1 year ago:
    "B15003_023",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_024",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_025"  #Estimate!!Total:!!Disc jockeys, except radio

              ) 

myTracts <- c(
    "42101007400", 
    "42101007300", 
    "42101008000", 
    "42101007800", 
    "42101007700",
    "42101008000",
    "42101007900",
    "42101008802", # just west of UPENN
    #"42101036900", # UPENN, hospitals, woodlands
    #"42101008801", # UPENN
    "42101008702",
    "42101008701",
    "42101008601"
              )


acsTractsPHL.2019.sf <- get_acs(geography = "tract",
                             year = 2019,
                             variables = acs_vars,
                             geometry = TRUE,
                             state  = "PA",
                             county = "Philadelphia",
                             output = "wide") %>%
  dplyr::select (GEOID, NAME, all_of(paste0(acs_vars,"E"))) %>%
  rename (
      total_pop.2019 = B01001_001E,    # ACS total Pop estimate
      total_25yrpop.2019 = B15003_001E,
      total_HU.2019 = B25002_001E,     # Estimate of total housing units
      total_vacant.2019 = B25002_003E,     # Number of vacant housing units
      med_HH_income.2019 = B19013_001E,    # Median HH Income ($)
      total_white.2019 = B02001_002E,  # People describing themselves as "white alone"
      total_indi.2019 = B07010_001E,     # Estimate!!Total Individuals
      total_no_income.2019 = B07010_002E,  # Estimate!!Total:!!No income
      total_income_75k.2019 = B07010_011E, # Estimate!!Total:!!With income:!!$75,000 or more
      total_moved_incnty.2019 = B07010_023E,   # Estimate!!Total:!!Moved within same county:
      total_moved_outcnty.2019 = B07010_034E,  # Estimate!!Total:!!Moved from different county:
      total_moved_outusa.2019 = B07010_045E,   # Estimate!!Total:!!Moved from different country:
      total_same_house_1yr.2019 = B07010_012E,  # Estimate!!Total:!!Same house 1 year ago:
      total_masters.2019 = B15003_023E
  ) %>%
  mutate(
    Neighborhood = ifelse(GEOID %in% myTracts,
                               "CLARK PARK",
                               "REST OF PHILADELPHIA"),
    moved_1yr_PCT.2019 = (1 - total_same_house_1yr.2019 / total_indi.2019 )*100,
    masters_PCT.2019 = ((total_masters.2019 + B15003_024E+ B15003_025E) / total_25yrpop.2019 )*100
    )
```

## Transform to WGS84 with {sf}

```{r}
acsTractsPHL.2019.sf <- acsTractsPHL.2019.sf %>% 
  st_transform(crs = "EPSG:4326")
```

## Plot with {ggplot2}

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}
max_pct = max(acsTractsPHL.2019.sf$moved_1yr_PCT.2019[is.finite(acsTractsPHL.2019.sf$moved_1yr_PCT.2019)])

ggplot()+
  # POLYGON color 
  geom_sf(data = acsTractsPHL.2019.sf, 
          aes(fill = moved_1yr_PCT.2019),
          color = "transparent")+
  # blank on top
  geom_sf(data = acsTractsPHL.2019.sf %>%
            filter(Neighborhood == "CLARK PARK") %>%
            st_union(),
            color = "black",
            size=1, #linetype="longdash",
            fill = "transparent"
          ) + 
  scale_fill_gradient2(
      low="green4", mid="white", high="red4", midpoint=20,
      breaks = c(0,20,40,60), labels = c("0%","20%","40%","60%"),
      name="% of New Residents")+
  guides(fill = guide_colourbar(barheight = 10))+
  labs(
    title = "Percentage of individuals who have moved in the last year",
    subtitle = "Focus on the Clark Park neighborhood") +
  theme(plot.title = element_text(hjust = 0.5), axis.title.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        panel.background = element_rect(fill='gray'))
```

\# )

\#brewer.pal(3, name="Dark2")

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}

library(RColorBrewer)


ggplot()+
  #POLYGON
  geom_sf(data = acsTractsPHL.2019.sf,
          fill = "white",
          color = "grey75"
          )+
  # POINT
  geom_sf(data = acsTractsPHL.2019.sf  %>%
          st_centroid(),                # to centroid
          shape = 21, color='grey10',
          aes(
            size = masters_PCT.2019,    # set point size by column value
            fill = masters_PCT.2019     # set point fill ('color') by column value
          )) +
  # Scale for the Point Size
  scale_size_continuous(
          range = c(0,6),             # range of point sizes
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          labels = c("0 to 19 %", "20 to 39 %", "40 to 59%", "60+ %"), 
                                        # legend labels
          name="% of People over 25yrs with a \nMaster's, Doctoral, or Professional Degree"
          )+
  scale_fill_stepsn(                    # binned scale of point fill
          colors = RColorBrewer::brewer.pal( # pulling ColorBrewer list of colors
                      4,                # amount of bins
                      name="BuPu"       # ColorBrewer palette
                      ),
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          guide = FALSE                 # remove legend (so we can have one combo)
          )+
    labs(
          title = "Percentage of Adults who earned \n a Master's Degree or Higher",
          ) +
    theme(
          axis.title=element_blank(), 
          axis.text=element_blank(), axis.ticks=element_blank(), # remove ticks
          panel.background = element_rect(fill='gray')
          )+
    guides(
          size = guide_legend(
              override.aes = list(fill = brewer.pal(4, name="BuPu"))
          ))                            # add the ColorBrewer list to the legend
```

```

------------------------------------------------------------------------

## 6 Geom Line Plots

***Rent & Crime compared to the Distance to BART stations***

```{r 6_geom_line}

```

------------------------------------------------------------------------

## 7 Policy Brief

------------------------------------------------------------------------

## Load data from {tidycensus}

```{r acs_vars, cache = TRUE, message = FALSE, warning = FALSE, results=FALSE}
acs_vars <- c(
    "B01001_001",    # ACS total Pop stimat
    "B15003_001",
    "B25002_001",     # stimat of total housing units
    "B25002_003",     # Numbr of vacant housing units
    "B19013_001",    # Mdian HH Incom ($)
    "B02001_002",  # Popl dscribing thmslvs as "whit alon"
    "B07010_001",     # stimat!!Total Individuals
    "B07010_002",  # stimat!!Total:!!No incom
    "B07010_011", # stimat!!Total:!!With incom:!!$75,000 or mor
    "B07010_023",   # stimat!!Total:!!Movd within sam county:
    "B07010_034",  # stimat!!Total:!!Movd from diffrnt county:
    "B07010_045",   # stimat!!Total:!!Movd from diffrnt country:
    "B07010_012",  # Estimate!!Total:!!Same house 1 year ago:
    "B15003_023",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_024",  #Estimate!!Total:!!Disc jockeys, except radio
    "B15003_025"  #Estimate!!Total:!!Disc jockeys, except radio

              ) 

myTracts <- c(
    "42101007400", 
    "42101007300", 
    "42101008000", 
    "42101007800", 
    "42101007700",
    "42101008000",
    "42101007900",
    "42101008802", # just west of UPENN
    #"42101036900", # UPENN, hospitals, woodlands
    #"42101008801", # UPENN
    "42101008702",
    "42101008701",
    "42101008601"
              )


acsTractsPHL.2019.sf <- get_acs(geography = "tract",
                             year = 2019,
                             variables = acs_vars,
                             geometry = TRUE,
                             state  = "PA",
                             county = "Philadelphia",
                             output = "wide") %>%
  dplyr::select (GEOID, NAME, all_of(paste0(acs_vars,"E"))) %>%
  rename (
      total_pop.2019 = B01001_001E,    # ACS total Pop estimate
      total_25yrpop.2019 = B15003_001E,
      total_HU.2019 = B25002_001E,     # Estimate of total housing units
      total_vacant.2019 = B25002_003E,     # Number of vacant housing units
      med_HH_income.2019 = B19013_001E,    # Median HH Income ($)
      total_white.2019 = B02001_002E,  # People describing themselves as "white alone"
      total_indi.2019 = B07010_001E,     # Estimate!!Total Individuals
      total_no_income.2019 = B07010_002E,  # Estimate!!Total:!!No income
      total_income_75k.2019 = B07010_011E, # Estimate!!Total:!!With income:!!$75,000 or more
      total_moved_incnty.2019 = B07010_023E,   # Estimate!!Total:!!Moved within same county:
      total_moved_outcnty.2019 = B07010_034E,  # Estimate!!Total:!!Moved from different county:
      total_moved_outusa.2019 = B07010_045E,   # Estimate!!Total:!!Moved from different country:
      total_same_house_1yr.2019 = B07010_012E,  # Estimate!!Total:!!Same house 1 year ago:
      total_masters.2019 = B15003_023E
  ) %>%
  mutate(
    Neighborhood = ifelse(GEOID %in% myTracts,
                               "CLARK PARK",
                               "REST OF PHILADELPHIA"),
    moved_1yr_PCT.2019 = (1 - total_same_house_1yr.2019 / total_indi.2019 )*100,
    masters_PCT.2019 = ((total_masters.2019 + B15003_024E+ B15003_025E) / total_25yrpop.2019 )*100
    )
```

## Transform to WGS84 with {sf}

```{r}
acsTractsPHL.2019.sf <- acsTractsPHL.2019.sf %>% 
  st_transform(crs = "EPSG:4326")
```

## Plot with {ggplot2}

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}
max_pct = max(acsTractsPHL.2019.sf$moved_1yr_PCT.2019[is.finite(acsTractsPHL.2019.sf$moved_1yr_PCT.2019)])

ggplot()+
  # POLYGON color 
  geom_sf(data = acsTractsPHL.2019.sf, 
          aes(fill = moved_1yr_PCT.2019),
          color = "transparent")+
  # blank on top
  geom_sf(data = acsTractsPHL.2019.sf %>%
            filter(Neighborhood == "CLARK PARK") %>%
            st_union(),
            color = "black",
            size=1, #linetype="longdash",
            fill = "transparent"
          ) + 
  scale_fill_gradient2(
      low="green4", mid="white", high="red4", midpoint=20,
      breaks = c(0,20,40,60), labels = c("0%","20%","40%","60%"),
      name="% of New Residents")+
  guides(fill = guide_colourbar(barheight = 10))+
  labs(
    title = "Percentage of individuals who have moved in the last year",
    subtitle = "Focus on the Clark Park neighborhood") +
  theme(plot.title = element_text(hjust = 0.5), axis.title.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        panel.background = element_rect(fill='gray'))
```

\# )

\#brewer.pal(3, name="Dark2")

```{r ggplot_geom_sf, warning = FALSE, echo = FALSE}

library(RColorBrewer)


ggplot()+
  #POLYGON
  geom_sf(data = acsTractsPHL.2019.sf,
          fill = "white",
          color = "grey75"
          )+
  # POINT
  geom_sf(data = acsTractsPHL.2019.sf  %>%
          st_centroid(),                # to centroid
          shape = 21, color='grey10',
          aes(
            size = masters_PCT.2019,    # set point size by column value
            fill = masters_PCT.2019     # set point fill ('color') by column value
          )) +
  # Scale for the Point Size
  scale_size_continuous(
          range = c(0,6),             # range of point sizes
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          labels = c("0 to 19 %", "20 to 39 %", "40 to 59%", "60+ %"), 
                                        # legend labels
          name="% of People over 25yrs with a \nMaster's, Doctoral, or Professional Degree"
          )+
  scale_fill_stepsn(                    # binned scale of point fill
          colors = RColorBrewer::brewer.pal( # pulling ColorBrewer list of colors
                      4,                # amount of bins
                      name="BuPu"       # ColorBrewer palette
                      ),
          breaks = c(0,20,40,60),       # value breaks/bins of point size
          guide = FALSE                 # remove legend (so we can have one combo)
          )+
    labs(
          title = "Percentage of Adults who earned \n a Master's Degree or Higher",
          ) +
    theme(
          axis.title=element_blank(), 
          axis.text=element_blank(), axis.ticks=element_blank(), # remove ticks
          panel.background = element_rect(fill='gray')
          )+
    guides(
          size = guide_legend(
              override.aes = list(fill = brewer.pal(4, name="BuPu"))
          ))                            # add the ColorBrewer list to the legend
```
